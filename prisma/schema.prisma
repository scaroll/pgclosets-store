generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String   @db.Text
  shortDesc     String?
  price         Decimal  @db.Decimal(10, 2)
  salePrice     Decimal? @db.Decimal(10, 2)
  sku           String?  @unique
  images        String[]
  specifications Json?
  features      String[]
  categoryId    String
  category      Category @relation(fields: [categoryId], references: [id])
  variants      ProductVariant[]
  reviews       Review[]
  orderItems    OrderItem[]
  featured      Boolean  @default(false)
  bestseller    Boolean  @default(false)
  inStock       Boolean  @default(true)
  stockCount    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ProductVariant {
  id          String  @id @default(cuid())
  productId   String
  product     Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  name        String
  sku         String? @unique
  price       Decimal @db.Decimal(10, 2)
  image       String?
  inStock     Boolean @default(true)
  attributes  Json?
}

model Category {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  image       String?
  parentId    String?
  parent      Category? @relation("CategoryChildren", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryChildren")
  products    Product[]
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  userId          String?
  user            User?       @relation(fields: [userId], references: [id])
  email           String
  phone           String?
  status          OrderStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentIntentId String?
  items           OrderItem[]
  subtotal        Decimal     @db.Decimal(10, 2)
  tax             Decimal     @db.Decimal(10, 2)
  shipping        Decimal     @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  shippingAddress Json?
  billingAddress  Json?
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model OrderItem {
  id         String  @id @default(cuid())
  orderId    String
  order      Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId  String
  product    Product @relation(fields: [productId], references: [id])
  variantId  String?
  name       String
  sku        String?
  price      Decimal @db.Decimal(10, 2)
  quantity   Int
  total      Decimal @db.Decimal(10, 2)
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phone         String?
  image         String?
  emailVerified DateTime?
  password      String?
  role          Role      @default(CUSTOMER)
  orders        Order[]
  reviews       Review[]
  appointments  Appointment[]
  addresses     Address[]
  // Quote relations
  quotes            Quote[]           @relation("CustomerQuotes")
  assignedQuotes    Quote[]           @relation("AssignedQuotes")
  statusChanges     QuoteStatusLog[]  @relation("StatusChanges")
  sentMessages      QuoteMessage[]    @relation("SentMessages")
  authoredNotes     QuoteNote[]       @relation("AuthoredNotes")
  techAppointments  QuoteAppointment[] @relation("TechAppointments")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Address {
  id         String  @id @default(cuid())
  userId     String
  user       User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  line1      String
  line2      String?
  city       String
  province   String
  postalCode String
  country    String  @default("CA")
  phone      String?
  isDefault  Boolean @default(false)
}

model Review {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  rating    Int
  title     String?
  comment   String?  @db.Text
  verified  Boolean  @default(false)
  helpful   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Appointment {
  id          String            @id @default(cuid())
  userId      String?
  user        User?             @relation(fields: [userId], references: [id])
  name        String
  email       String
  phone       String
  date        DateTime
  timeSlot    String
  address     String
  city        String
  postalCode  String
  notes       String?
  type        AppointmentType   @default(MEASURE)
  status      AppointmentStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model Testimonial {
  id        String   @id @default(cuid())
  name      String
  location  String?
  rating    Int      @default(5)
  quote     String   @db.Text
  image     String?
  featured  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model BlogPost {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  excerpt     String?
  content     String   @db.Text
  image       String?
  author      String?
  published   Boolean  @default(false)
  publishedAt DateTime?
  tags        String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum Role {
  CUSTOMER
  ADMIN
}

enum AppointmentType {
  MEASURE
  CONSULTATION
  INSTALLATION
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

// ==================== QUOTE SYSTEM ====================

model Quote {
  id                String          @id @default(cuid())
  quoteNumber       String          @unique
  status            QuoteStatus     @default(DRAFT)

  // Customer
  customerId        String?
  customer          User?           @relation("CustomerQuotes", fields: [customerId], references: [id])
  customerName      String
  customerEmail     String
  customerPhone     String

  // Property
  propertyAddress   Json?
  propertyType      String?
  propertyNotes     String?         @db.Text

  // Configurations
  configurations    QuoteConfig[]

  // Pricing
  subtotal          Decimal         @db.Decimal(10, 2)
  installationFee   Decimal         @default(0) @db.Decimal(10, 2)
  travelFee         Decimal         @default(0) @db.Decimal(10, 2)
  discount          Decimal         @default(0) @db.Decimal(10, 2)
  discountReason    String?
  taxRate           Decimal         @default(0.13) @db.Decimal(5, 4)
  tax               Decimal         @db.Decimal(10, 2)
  total             Decimal         @db.Decimal(10, 2)

  // Terms
  depositPercent    Int             @default(50)
  depositAmount     Decimal?        @db.Decimal(10, 2)
  paymentTerms      String?
  validUntil        DateTime?

  // Assignment
  assignedRepId     String?
  assignedRep       User?           @relation("AssignedQuotes", fields: [assignedRepId], references: [id])

  // Documents
  formalQuotePdf    String?
  contractPdf       String?
  signedAt          DateTime?
  signatureData     String?         @db.Text

  // Relationships
  appointments      QuoteAppointment[]
  payments          QuotePayment[]
  messages          QuoteMessage[]
  notes             QuoteNote[]
  statusHistory     QuoteStatusLog[]

  // Timestamps
  submittedAt       DateTime?
  reviewedAt        DateTime?
  quotedAt          DateTime?
  approvedAt        DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([status])
  @@index([customerEmail])
  @@index([assignedRepId])
  @@index([quoteNumber])
}

model QuoteConfig {
  id              String    @id @default(cuid())
  quoteId         String
  quote           Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  roomName        String
  openingType     String

  // Door Configuration
  productId       String?
  series          String
  doorType        String
  widthInches     Decimal   @db.Decimal(6, 2)
  heightInches    Decimal   @db.Decimal(6, 2)
  panelCount      Int
  finish          String
  hardware        String
  handles         String
  softClose       Boolean   @default(false)
  mirror          Boolean   @default(false)
  customOptions   Json?

  // Pricing
  unitPrice       Decimal   @db.Decimal(10, 2)
  quantity        Int       @default(1)
  lineTotal       Decimal   @db.Decimal(10, 2)

  // Notes & Photos
  notes           String?   @db.Text
  photos          String[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([quoteId])
}

model QuoteStatusLog {
  id          String       @id @default(cuid())
  quoteId     String
  quote       Quote        @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  fromStatus  QuoteStatus?
  toStatus    QuoteStatus
  changedById String?
  changedBy   User?        @relation("StatusChanges", fields: [changedById], references: [id])
  reason      String?
  createdAt   DateTime     @default(now())

  @@index([quoteId])
}

model QuoteMessage {
  id          String    @id @default(cuid())
  quoteId     String
  quote       Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User      @relation("SentMessages", fields: [senderId], references: [id])
  message     String    @db.Text
  attachments String[]
  isInternal  Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([quoteId])
}

model QuoteNote {
  id        String   @id @default(cuid())
  quoteId   String
  quote     Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation("AuthoredNotes", fields: [authorId], references: [id])
  content   String   @db.Text
  createdAt DateTime @default(now())

  @@index([quoteId])
}

model QuotePayment {
  id              String              @id @default(cuid())
  quoteId         String
  quote           Quote               @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  type            QuotePaymentType
  amount          Decimal             @db.Decimal(10, 2)
  method          String              // stripe, etransfer, cash, cheque
  status          QuotePaymentStatus  @default(PENDING)

  stripePaymentId String?
  invoiceNumber   String?
  invoicePdf      String?

  dueDate         DateTime?
  paidAt          DateTime?

  notes           String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([quoteId])
  @@index([status])
}

model QuoteAppointment {
  id              String                    @id @default(cuid())
  quoteId         String
  quote           Quote                     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  type            QuoteAppointmentType
  status          QuoteAppointmentStatus    @default(SCHEDULED)

  scheduledDate   DateTime
  scheduledTime   String                    // "09:00-11:00"
  duration        Int                       // minutes

  assignedTechId  String?
  assignedTech    User?                     @relation("TechAppointments", fields: [assignedTechId], references: [id])

  address         Json
  notes           String?                   @db.Text
  customerNotes   String?                   @db.Text

  completedAt     DateTime?
  completionNotes String?                   @db.Text
  photos          String[]
  signature       String?                   @db.Text

  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([quoteId])
  @@index([scheduledDate])
  @@index([assignedTechId])
}

model ServiceZone {
  id              String    @id @default(cuid())
  name            String    // "Ottawa Central", "Orleans", etc.
  postalCodes     String[]
  laborRate       Decimal   @db.Decimal(10, 2)
  travelFee       Decimal   @db.Decimal(10, 2)
  minOrderValue   Decimal   @db.Decimal(10, 2)
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==================== QUOTE ENUMS ====================

enum QuoteStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  MEASUREMENT_SCHEDULED
  MEASUREMENT_COMPLETED
  QUOTED
  REVISION_REQUESTED
  APPROVED
  DEPOSIT_PAID
  IN_PRODUCTION
  READY_FOR_INSTALL
  INSTALLATION_SCHEDULED
  INSTALLED
  COMPLETED
  EXPIRED
  CANCELLED
}

enum QuotePaymentType {
  DEPOSIT
  PROGRESS
  FINAL
  REFUND
}

enum QuotePaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum QuoteAppointmentType {
  MEASUREMENT
  INSTALLATION
  FOLLOW_UP
}

enum QuoteAppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}
